<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eDiscover - AI Document Review</title>
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Smooth scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #475569 0%, #334155 100%);
            border-radius: 5px;
            border: 2px solid #0f172a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #64748b 0%, #475569 100%);
        }

        /* Gradient background */
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }

        /* Style for the selected document */
        .doc-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        .doc-item:hover {
            background-color: #334155 !important;
            border-left-color: #3b82f6;
            transform: translateX(2px);
        }
        .doc-item.selected {
            background: linear-gradient(90deg, #1e3a8a 0%, #1e40af 100%) !important;
            border-left-color: #60a5fa;
            font-weight: 600;
        }

        /* Tab styling with modern look */
        .tab-btn {
            background-color: transparent;
            position: relative;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-btn:hover {
            background-color: #1e293b;
        }
        .tab-btn.active {
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            border-bottom-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* Modern button styling */
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.6);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 6px 8px -1px rgba(16, 185, 129, 0.6);
            transform: translateY(-1px);
        }

        /* Custom file input button styling */
        .file-input-btn {
            display: inline-block;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);
        }
        .file-input-btn:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.6);
            transform: translateY(-1px);
        }
        .file-input-btn-label {
            display: inline-block;
            margin-left: 12px;
            color: #94a3b8;
            font-weight: 500;
        }

        /* Hide the actual file input */
        input[type="file"].hidden-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        /* Enhanced input fields */
        input[type="text"], input[type="search"] {
            transition: all 0.3s ease;
        }
        input[type="text"]:focus, input[type="search"]:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* AI Panel styles */
        .ai-response {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Inter', sans-serif;
            line-height: 1.8;
            font-size: 15px;
            color: #e2e8f0;
        }

        /* Modern loading spinner */
        .spinner {
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced source links */
        .ai-source-link {
            display: inline-block;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: #e0e7ff;
            padding: 6px 12px;
            border-radius: 0.375rem;
            margin: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(96, 165, 250, 0.3);
        }
        .ai-source-link:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.5);
        }

        /* Card styling */
        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        /* Header gradient */
        header {
            background: linear-gradient(90deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
        }

        /* Panel backgrounds */
        .panel-bg {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            border-radius: 0.75rem;
        }

        @media (max-width: 768px) {
            #mobile-warning {
                display: flex;
            }
            #main-content, header {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans h-full flex flex-col antialiased">

    <!-- Mobile Warning -->
    <div id="mobile-warning" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 z-50 hidden">
        <div class="text-center text-white">
            <svg class="mx-auto h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <h2 class="mt-6 text-2xl font-bold">Screen Too Small</h2>
            <p class="mt-2 text-lg text-gray-300">For the best experience, please use eDiscover on a desktop or laptop computer.</p>
            <p class="mt-1 text-sm text-gray-400">The interface is not optimized for mobile devices.</p>
        </div>
    </div>

    <!-- Header -->
    <header class="shadow-lg p-4 flex justify-between items-center z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center shadow-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">eDiscover</h1>
                <p class="text-xs text-slate-400 font-medium">AI-Powered Document Review</p>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <small id="version-display" class="text-slate-400 font-medium cursor-pointer hover:text-slate-200 transition-colors" title="Click for admin unlock">v<span id="version-number">-</span></small>
            <div id="usage-display" class="hidden text-xs text-slate-400 font-medium px-3 py-1.5 bg-slate-700/50 rounded-lg">
                <span id="usage-text">-</span>
            </div>
            <div id="auth-status" class="text-sm text-slate-300 font-medium px-3 py-1 bg-slate-700/50 rounded-lg">initializing...</div>
            <button id="signout-btn" class="hidden text-sm text-slate-300 hover:text-white font-medium px-4 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg transition-colors">
                Sign Out
            </button>
        </div>
    </header>

    <!-- Login Screen -->
    <div id="login-screen" class="flex-1 flex items-center justify-center p-8 hidden">
        <div class="max-w-md w-full">
            <div class="card p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center shadow-lg mx-auto mb-4">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Welcome to eDiscover</h2>
                    <p class="text-slate-400">Please sign in to continue</p>
                </div>

                <div id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                            <input type="email" id="login-email" placeholder="you@example.com" class="w-full bg-slate-700/70 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Password</label>
                            <input type="password" id="login-password" placeholder="••••••••" class="w-full bg-slate-700/70 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div id="login-error" class="text-red-400 text-sm hidden"></div>
                        <button id="login-btn" class="btn-primary w-full text-white font-bold py-3 px-6 rounded-lg focus:outline-none">
                            Sign In
                        </button>
                        <div class="text-center mt-4">
                            <button id="show-signup-btn" class="text-blue-400 hover:text-blue-300 text-sm">
                                Don't have an account? Sign up
                            </button>
                        </div>
                    </div>
                </div>

                <div id="signup-form" class="hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                            <input type="email" id="signup-email" placeholder="you@example.com" class="w-full bg-slate-700/70 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Password</label>
                            <input type="password" id="signup-password" placeholder="••••••••" class="w-full bg-slate-700/70 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Confirm Password</label>
                            <input type="password" id="signup-password-confirm" placeholder="••••••••" class="w-full bg-slate-700/70 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div id="signup-error" class="text-red-400 text-sm hidden"></div>
                        <button id="signup-btn" class="btn-success w-full text-white font-bold py-3 px-6 rounded-lg focus:outline-none">
                            Create Account
                        </button>
                        <div class="text-center mt-4">
                            <button id="show-login-btn" class="text-blue-400 hover:text-blue-300 text-sm">
                                Already have an account? Sign in
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-content" class="flex-1 flex flex-col hidden overflow-hidden">
        
        <!-- Main Tabs -->
        <div id="main-tabs" class="flex border-b border-slate-700 bg-slate-800/50 backdrop-blur-sm">
            <button id="tab-ingest" data-target="ingest-view" class="tab-btn active text-white font-semibold py-4 px-8 focus:outline-none flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                Ingest
            </button>
            <button id="tab-review" data-target="review-view" class="tab-btn text-white font-semibold py-4 px-8 focus:outline-none flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                Review
            </button>
            <button id="tab-analyze" data-target="panel-ai" class="tab-btn text-white font-semibold py-4 px-8 focus:outline-none flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Analyze
            </button>
        </div>

        <!-- Views Container -->
        <div id="main-views" class="flex-1 flex overflow-hidden">
            
            <!-- Ingest View -->
            <div id="ingest-view" class="tab-panel p-8 w-full overflow-y-auto">
                <div class="max-w-3xl mx-auto">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold mb-2 text-white">Ingest New Data</h2>
                        <p class="text-slate-400">Upload your document collection for AI-powered analysis</p>
                    </div>
                    <div class="space-y-6">
                        <!-- .dat File Input -->
                        <div class="card p-6">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-white mb-2">Load File</h3>
                                    <label for="dat-file-input" class="file-input-btn">Choose .dat File</label>
                                    <span id="dat-file-label" class="file-input-btn-label">No file selected</span>
                                    <input type="file" id="dat-file-input" class="hidden-file-input" accept=".dat">
                                    <p class="text-sm text-slate-400 mt-3">Select the main .dat load file containing document metadata</p>
                                </div>
                            </div>
                        </div>

                        <!-- NATIVE Folder Input -->
                        <div class="card p-6">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-white mb-2">Native Files</h3>
                                    <label for="native-folder-input" class="file-input-btn">Choose NATIVE Folder</label>
                                    <span id="native-folder-label" class="file-input-btn-label">No folder selected</span>
                                    <input type="file" id="native-folder-input" class="hidden-file-input" webkitdirectory directory>
                                    <p class="text-sm text-slate-400 mt-3">Select the folder containing original native files (PDFs, emails, etc.)</p>
                                </div>
                            </div>
                        </div>

                        <!-- TEXT Folder Input -->
                        <div class="card p-6">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-white mb-2">Text Files</h3>
                                    <label for="text-folder-input" class="file-input-btn">Choose TEXT Folder</label>
                                    <span id="text-folder-label" class="file-input-btn-label">No folder selected</span>
                                    <input type="file" id="text-folder-input" class="hidden-file-input" webkitdirectory directory>
                                    <p class="text-sm text-slate-400 mt-3">Select the folder containing OCR/extracted text files for AI processing</p>
                                </div>
                            </div>
                        </div>

                        <!-- Ingest Button -->
                        <div class="pt-6">
                            <button id="ingest-btn" class="btn-success text-white font-bold py-4 px-8 rounded-lg text-lg focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Start Ingestion
                            </button>
                            <p id="ingest-progress" class="text-slate-300 mt-4 font-medium h-6"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review View -->
            <div id="review-view" class="tab-panel hidden flex-1 flex flex-row overflow-hidden">
                <!-- Document List (Left Panel) -->
                <div class="w-1/4 flex flex-col bg-slate-800/50 border-r border-slate-700/50 backdrop-blur-sm">
                    <div class="p-4 border-b border-slate-700/50">
                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="search" id="doc-search" placeholder="Search documents..." class="w-full bg-slate-700/70 text-white rounded-lg pl-10 pr-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                        </div>
                        <div id="doc-count" class="text-center text-xs text-slate-400 pt-3 font-semibold">Loading...</div>
                    </div>
                    <div id="doc-list" class="flex-1 overflow-y-auto">
                        <!-- Doc items will be injected here -->
                    </div>
                    <div id="doc-list-placeholder" class="flex-1 flex flex-col items-center justify-center text-slate-500 p-6 text-center">
                        <svg class="w-16 h-16 mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="font-medium">Initializing...</p>
                    </div>
                </div>

                <!-- Viewer (Right Panel) -->
                <div class="w-3/4 flex flex-col overflow-hidden">
                    <!-- Viewer Tabs -->
                    <div id="viewer-tabs" class="flex border-b border-slate-700/50 bg-slate-800/30 backdrop-blur-sm">
                        <button id="tab-text" data-target="panel-text" class="tab-btn active text-white font-semibold py-3 px-6 focus:outline-none flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Text
                        </button>
                        <button id="tab-native" data-target="panel-native" class="tab-btn text-white font-semibold py-3 px-6 focus:outline-none flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            Native
                        </button>
                        <button id="tab-metadata" data-target="panel-metadata" class="tab-btn text-white font-semibold py-3 px-6 focus:outline-none flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Metadata
                        </button>
                    </div>
                    
                    <!-- Viewer Panels -->
                    <div id="viewer-panels" class="flex-1 relative overflow-hidden">
                        <div id="panel-text" class="tab-panel w-full h-full overflow-y-auto p-6 whitespace-pre-wrap break-words">
                            <div class="flex flex-col items-center justify-center h-full text-slate-500">
                                <svg class="w-20 h-20 mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-lg font-semibold">No Document Selected</p>
                                <p class="text-sm text-slate-600 mt-2">Select a document from the list to view its text content</p>
                            </div>
                        </div>
                        <div id="panel-native" class="tab-panel hidden w-full h-full flex items-center justify-center">
                            <div class="flex flex-col items-center justify-center text-slate-500">
                                <svg class="w-20 h-20 mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                                <p class="text-lg font-semibold">No Document Selected</p>
                                <p class="text-sm text-slate-600 mt-2">Select a document from the list to view the native file</p>
                            </div>
                        </div>
                        <div id="panel-metadata" class="tab-panel hidden w-full h-full overflow-y-auto p-6">
                            <div class="flex flex-col items-center justify-center h-full text-slate-500">
                                <svg class="w-20 h-20 mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="text-lg font-semibold">No Document Selected</p>
                                <p class="text-sm text-slate-600 mt-2">Select a document from the list to view its metadata</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Assistant Panel -->
            <div id="panel-ai" class="tab-panel hidden w-full h-full flex flex-col p-6 overflow-hidden">
                <div class="flex-1 overflow-y-auto panel-bg p-6 mb-4">
                    <div id="ai-loading" class="hidden flex-col items-center justify-center h-full">
                        <div class="spinner"></div>
                        <p class="text-slate-400 mt-4 font-medium">Searching database and reading documents...</p>
                    </div>
                    <div id="ai-response-content" class="ai-response">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-2">AI Document Assistant</h3>
                                <p class="text-slate-300 leading-relaxed">Ask questions about your entire document collection. I'll search the metadata to find relevant files, analyze their content, and provide comprehensive answers with source citations.</p>
                            </div>
                        </div>
                    </div>
                    <div id="ai-sources" class="mt-6 pt-6 border-t border-slate-700/50">
                        <!-- AI sources will be injected here -->
                    </div>
                    <div id="ai-token-info" class="mt-4 text-xs text-slate-400 hidden">
                        <!-- Token information will be injected here -->
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <div class="relative">
                        <input type="text" id="ai-query-input" placeholder="Ask about your documents..." class="w-full bg-slate-700/70 text-white rounded-lg pl-4 pr-24 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium text-base">
                        <button id="ai-query-btn" class="btn-primary absolute right-2 top-1/2 transform -translate-y-1/2 text-white font-semibold py-2 px-6 rounded-lg focus:outline-none flex items-center gap-2">
                            <span>Send</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-slate-400 mt-2 ml-1">Example: "Summarize documents from Danny Lee about Symbio"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Unlock Modal -->
    <div id="admin-unlock-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 max-w-md w-full border border-slate-700">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-700 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-white">Unlock Admin Mode</h3>
            </div>
            <p class="text-slate-300 mb-4">Enter the admin unlock code to get unlimited AI queries.</p>
            <input type="password" id="admin-unlock-code" placeholder="Enter unlock code" class="w-full bg-slate-700/70 text-white rounded-lg px-4 py-3 mb-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <div id="admin-unlock-error" class="text-red-400 text-sm mb-3 hidden"></div>
            <div id="admin-unlock-success" class="text-green-400 text-sm mb-3 hidden"></div>
            <div class="flex gap-3">
                <button id="admin-unlock-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none transition-colors">
                    Unlock
                </button>
                <button id="admin-unlock-cancel" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg focus:outline-none transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder -->
    <!-- The modal will be added here by JavaScript -->

    <!-- Firebase SDKs and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            collection,
            onSnapshot,
            query,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        // *** NEW *** Import Firebase Functions
        import {
            getFunctions,
            httpsCallable
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Import Firebase configuration from external file
        import { firebaseConfig, appId as configAppId } from './js/firebase-config.js';

        // --- GLOBAL STATE ---
        let db, auth, storage, functions;
        let userId, appId;
        let allDocuments = [];
        let currentDocument = null;
        let unsubscribeDocListener = null;

        // Cloud Function references
        let docQuery;
        let unlockAdminMode;

        // --- Wait for DOM to load before running app logic ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- UI ELEMENTS ---
            const authStatusEl = document.getElementById('auth-status');
            const mainContent = document.getElementById('main-content');
            const loginScreen = document.getElementById('login-screen');
            const signoutBtn = document.getElementById('signout-btn');

            // Login form elements
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const loginEmail = document.getElementById('login-email');
            const loginPassword = document.getElementById('login-password');
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');
            const signupEmail = document.getElementById('signup-email');
            const signupPassword = document.getElementById('signup-password');
            const signupPasswordConfirm = document.getElementById('signup-password-confirm');
            const signupBtn = document.getElementById('signup-btn');
            const signupError = document.getElementById('signup-error');
            const showSignupBtn = document.getElementById('show-signup-btn');
            const showLoginBtn = document.getElementById('show-login-btn');

            const ingestTabBtn = document.getElementById('tab-ingest');
            const reviewTabBtn = document.getElementById('tab-review');
            const ingestView = document.getElementById('ingest-view');
            const reviewView = document.getElementById('review-view');
            
            const datFileInput = document.getElementById('dat-file-input');
            const nativeFolderInput = document.getElementById('native-folder-input');
            const textFolderInput = document.getElementById('text-folder-input');
            
            const datFileLabel = document.getElementById('dat-file-label');
            const nativeFolderLabel = document.getElementById('native-folder-label');
            const textFolderLabel = document.getElementById('text-folder-label');
            
            const ingestBtn = document.getElementById('ingest-btn');
            const ingestProgress = document.getElementById('ingest-progress');
            
            const docListEl = document.getElementById('doc-list');
            const docSearchEl = document.getElementById('doc-search');
            const docCountEl = document.getElementById('doc-count');
            const docListPlaceholder = document.getElementById('doc-list-placeholder');

            const textTabBtn = document.getElementById('tab-text');
            const metadataTabBtn = document.getElementById('tab-metadata');
            const nativeTabBtn = document.getElementById('tab-native');
            const aiTabBtn = document.getElementById('tab-ai');
            const textPanel = document.getElementById('panel-text');
            const metadataPanel = document.getElementById('panel-metadata');
            const nativePanel = document.getElementById('panel-native');
            const aiPanel = document.getElementById('panel-ai');

            // AI Panel Elements
            const aiQueryInput = document.getElementById('ai-query-input');
            const aiQueryBtn = document.getElementById('ai-query-btn');
            const aiLoadingEl = document.getElementById('ai-loading');
            const aiResponseContentEl = document.getElementById('ai-response-content');
            const aiSourcesEl = document.getElementById('ai-sources');
            const aiTokenInfoEl = document.getElementById('ai-token-info');

            // Usage display elements
            const versionDisplay = document.getElementById('version-display');
            const usageDisplay = document.getElementById('usage-display');
            const usageText = document.getElementById('usage-text');

            // Admin unlock modal elements
            const adminUnlockModal = document.getElementById('admin-unlock-modal');
            const adminUnlockCode = document.getElementById('admin-unlock-code');
            const adminUnlockBtn = document.getElementById('admin-unlock-btn');
            const adminUnlockCancel = document.getElementById('admin-unlock-cancel');
            const adminUnlockError = document.getElementById('admin-unlock-error');
            const adminUnlockSuccess = document.getElementById('admin-unlock-success');

            // Remove any existing queryGemini function to prevent direct API calls
            if (window.queryGemini) {
                delete window.queryGemini;
            }

            // --- AUTH UI HANDLERS ---
            // Toggle between login and signup forms
            showSignupBtn.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                loginError.classList.add('hidden');
                signupError.classList.add('hidden');
            });

            showLoginBtn.addEventListener('click', () => {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                loginError.classList.add('hidden');
                signupError.classList.add('hidden');
            });

            // Handle login
            loginBtn.addEventListener('click', async () => {
                const email = loginEmail.value.trim();
                const password = loginPassword.value;

                if (!email || !password) {
                    loginError.textContent = 'Please enter both email and password';
                    loginError.classList.remove('hidden');
                    return;
                }

                try {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Signing in...';
                    await signInWithEmailAndPassword(auth, email, password);
                    loginError.classList.add('hidden');
                } catch (error) {
                    console.error('Login error:', error);
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            });

            // Handle Enter key for login
            loginPassword.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') loginBtn.click();
            });

            // Handle signup
            signupBtn.addEventListener('click', async () => {
                const email = signupEmail.value.trim();
                const password = signupPassword.value;
                const passwordConfirm = signupPasswordConfirm.value;

                if (!email || !password || !passwordConfirm) {
                    signupError.textContent = 'Please fill in all fields';
                    signupError.classList.remove('hidden');
                    return;
                }

                if (password !== passwordConfirm) {
                    signupError.textContent = 'Passwords do not match';
                    signupError.classList.remove('hidden');
                    return;
                }

                if (password.length < 6) {
                    signupError.textContent = 'Password must be at least 6 characters';
                    signupError.classList.remove('hidden');
                    return;
                }

                try {
                    signupBtn.disabled = true;
                    signupBtn.textContent = 'Creating account...';
                    await createUserWithEmailAndPassword(auth, email, password);
                    signupError.classList.add('hidden');
                } catch (error) {
                    console.error('Signup error:', error);
                    signupError.textContent = error.message;
                    signupError.classList.remove('hidden');
                    signupBtn.disabled = false;
                    signupBtn.textContent = 'Create Account';
                }
            });

            // Handle signout
            signoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            });

            // --- ADMIN UNLOCK HANDLERS ---
            // Show unlock modal when version number is clicked
            versionDisplay.addEventListener('click', () => {
                if (!userId) {
                    alert('Please sign in first');
                    return;
                }
                adminUnlockModal.classList.remove('hidden');
                adminUnlockCode.value = '';
                adminUnlockError.classList.add('hidden');
                adminUnlockSuccess.classList.add('hidden');
                adminUnlockCode.focus();
            });

            // Handle unlock button
            adminUnlockBtn.addEventListener('click', async () => {
                const code = adminUnlockCode.value.trim();

                if (!code) {
                    adminUnlockError.textContent = 'Please enter an unlock code';
                    adminUnlockError.classList.remove('hidden');
                    return;
                }

                try {
                    adminUnlockBtn.disabled = true;
                    adminUnlockBtn.textContent = 'Unlocking...';
                    adminUnlockError.classList.add('hidden');

                    const result = await unlockAdminMode({ code });

                    if (result.data.success) {
                        adminUnlockSuccess.textContent = '✓ Admin mode unlocked! You now have unlimited AI queries.';
                        adminUnlockSuccess.classList.remove('hidden');
                        adminUnlockCode.value = '';

                        // Update usage display
                        usageText.textContent = 'Unlimited queries (Admin)';
                        usageText.className = 'text-green-400 font-semibold';

                        setTimeout(() => {
                            adminUnlockModal.classList.add('hidden');
                        }, 2000);
                    } else {
                        adminUnlockError.textContent = result.data.error || 'Invalid unlock code';
                        adminUnlockError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Unlock error:', error);
                    adminUnlockError.textContent = error.message || 'An error occurred';
                    adminUnlockError.classList.remove('hidden');
                } finally {
                    adminUnlockBtn.disabled = false;
                    adminUnlockBtn.textContent = 'Unlock';
                }
            });

            // Handle Enter key in unlock code input
            adminUnlockCode.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') adminUnlockBtn.click();
            });

            // Handle cancel button
            adminUnlockCancel.addEventListener('click', () => {
                adminUnlockModal.classList.add('hidden');
            });

            // Close modal when clicking outside
            adminUnlockModal.addEventListener('click', (e) => {
                if (e.target === adminUnlockModal) {
                    adminUnlockModal.classList.add('hidden');
                }
            });

            // --- 1. INITIALIZATION ---
            // Load version number (robust: handle 404 or HTML error pages)
            (async () => {
                try {
                    const resp = await fetch('/version.json');
                    if (!resp.ok) {
                        console.debug('version.json not found or returned error', resp.status);
                        document.getElementById('version-number').textContent = 'n/a';
                        return;
                    }
                    const contentType = resp.headers.get('content-type') || '';
                    if (!contentType.includes('application/json')) {
                        console.debug('version.json returned non-JSON content-type:', contentType);
                        document.getElementById('version-number').textContent = 'n/a';
                        return;
                    }
                    const data = await resp.json();
                    if (data && data.version) {
                        document.getElementById('version-number').textContent = data.version;
                    } else {
                        document.getElementById('version-number').textContent = 'n/a';
                    }
                } catch (err) {
                    console.debug('Could not load version.json:', err.message || err);
                    document.getElementById('version-number').textContent = 'n/a';
                }
            })();
            function initializeAppLogic() {
                try {
                    // Firebase config is now imported from ./js/firebase-config.js
                    // If you need to update the configuration, edit that file
                    
                    // Use a hardcoded, unique ID for your app's data
                    appId = configAppId; 

                    // Check if config is still the placeholder
                    if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                         throw new Error("Please copy firebase-config.template.js to firebase-config.js and add your Firebase configuration.");
                    }

                    // Init Firebase
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    storage = getStorage(app);
                    
                    // Initialize Firebase Functions and create callable references
                    functions = getFunctions(app);
                    functions.region = 'us-central1'; // Explicitly set region
                    docQuery = httpsCallable(functions, 'docQuery');
                    unlockAdminMode = httpsCallable(functions, 'unlockAdminMode');

                    console.log('Firebase initialization complete');

                    // Enable debug logging for Firestore
                    setLogLevel('Debug');

                    // --- 2. AUTHENTICATION ---
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // User is signed in
                            userId = user.uid;
                            const userEmail = user.email || 'Unknown user';
                            authStatusEl.textContent = userEmail;
                            loginScreen.classList.add('hidden');
                            mainContent.classList.remove('hidden');
                            signoutBtn.classList.remove('hidden');
                            // Reset login form
                            loginBtn.disabled = false;
                            loginBtn.textContent = 'Sign In';
                            signupBtn.disabled = false;
                            signupBtn.textContent = 'Create Account';
                            loginEmail.value = '';
                            loginPassword.value = '';
                            signupEmail.value = '';
                            signupPassword.value = '';
                            signupPasswordConfirm.value = '';
                            // Start listening for documents
                            loadDocumentList();
                        } else {
                            // No user, show login screen
                            userId = null;
                            authStatusEl.textContent = 'Not logged in';
                            mainContent.classList.add('hidden');
                            loginScreen.classList.remove('hidden');
                            signoutBtn.classList.add('hidden');
                        }
                    });

                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    authStatusEl.textContent = `Error: ${error.message}`;
                }
            }

            // --- 3. INGESTION LOGIC ---
            // (This section is unchanged from the previous version)

            /**
             * Helper function to bind file input to its label for better UI
             */
            function setupFileInput(inputId, labelId) {
                const input = document.getElementById(inputId);
                const label = document.getElementById(labelId);
                if (!input || !label) {
                    console.warn(`Could not find input ${inputId} or label ${labelId}`);
                    return;
                }
                const labelText = label.textContent;

                input.addEventListener('change', () => {
                    if (input.files.length > 0) {
                        if (input.webkitdirectory) {
                            label.textContent = `${input.files.length} files selected`;
                        } else {
                            label.textContent = input.files[0].name;
                        }
                    } else {
                        label.textContent = labelText;
                    }
                });
            }
            setupFileInput('dat-file-input', 'dat-file-label');
            setupFileInput('native-folder-input', 'native-folder-label');
            setupFileInput('text-folder-input', 'text-folder-label');

            /**
             * Attempts to read a file using multiple common encodings.
             * @param {File} file - The .dat file to read.
             * @returns {Promise<string>} The file content as a string.
             */
            async function readDatFileWithEncodings(file) {
                // iso-8859-1 (latin-1) is the most likely for Concordance files
                const encodingsToTry = ['iso-8859-1', 'utf-8', 'windows-1252'];
                
                for (const encoding of encodingsToTry) {
                    try {
                        console.log(`Attempting to read .dat with encoding: ${encoding}`);
                        // Use a FileReader to read as ArrayBuffer first
                        const buffer = await file.arrayBuffer();
                        // Use fatal: true to ensure it fails on bad encoding, not replace characters
                        const decoder = new TextDecoder(encoding, { fatal: true }); 
                        const content = decoder.decode(buffer);
                        
                        // Simple heuristic: if it contains the known delimiter, it's probably right.
                        if (content.includes(String.fromCharCode(20))) {
                            console.log(`Successfully read with ${encoding}`);
                            return content;
                        }
                    } catch (e) {
                        console.warn(`Failed to read with ${encoding}:`, e.message);
                    }
                }
                throw new Error("Could not determine correct .dat file encoding. Tried iso-8859-1, utf-8, and windows-1252.");
            }

            /**
             * Parses a Concordance-style .dat file in the browser.
             * @param {string} datContent - The full text content of the .dat file.
             * @returns {Array<Object>} An array of document metadata objects.
             */
            function parseDAT(datContent) {
                console.log("Parsing .dat content...");
                // Use a regex to split by any common line ending (\r\n, \n, or \r)
                const lines = datContent.split(/\r\n?|\n/);
                console.log(`File split into ${lines.length} lines.`);
                
                if (lines.length < 2) {
                    throw new Error("File is empty or has no header line.");
                }

                const delimiter = String.fromCharCode(20); // ASCII 20
                const quoteChar = String.fromCharCode(254); // ASCII 254 (þ)
                
                // Helper to clean the field names from the header
                const cleanHeader = (header) => {
                    let clean = header;
                    if (clean.startsWith(quoteChar)) {
                        clean = clean.substring(1); // Remove prefix quote
                    }
                    if (clean.endsWith(delimiter)) {
                        clean = clean.substring(0, clean.length - 1); // Remove suffix delimiter
                    }
                    if (clean.endsWith(quoteChar)) {
                        clean = clean.substring(0, clean.length - 1); // Remove suffix quote
                    }
                    return clean;
                };

                let headerLine = lines[0];
                
                // --- FIX FOR BOM ---
                // Check for and remove Byte Order Mark (BOM) if it exists
                if (headerLine.charCodeAt(0) === 0xFEFF || headerLine.charCodeAt(0) === 0xFFFE) {
                    console.log("Detected and removed BOM from header.");
                    headerLine = headerLine.substring(1);
                }

                const headers = headerLine.trim().split(delimiter).map(cleanHeader).filter(h => h); // Filter out empty strings
                
                // Check for mandatory header
                if (!headers.includes("Beg Bates")) {
                    console.error("--- DEBUG: HEADERS FOUND ---");
                    headers.forEach((h, i) => {
                        console.log(`Header[${i}]: "${h}" (Length: ${h.length})`);
                        // Log char codes for debugging invisible characters
                        let codes = '';
                        for(let c = 0; c < h.length; c++) codes += h.charCodeAt(c) + ' ';
                        console.log(`    Char Codes: ${codes}`);
                    });
                    console.error("-----------------------------");
                    throw new Error("Could not find required 'Beg Bates' column. Check .dat file format and console for debug info.");
                }

                const records = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === "") continue; // Skip empty lines

                    const values = lines[i].split(delimiter);
                    
                    if (values.length < headers.length) {
                        console.warn(`Skipping malformed line ${i + 1}: expected ${headers.length} fields, got ${values.length}`);
                        continue; 
                    }

                    const record = {};
                    for (let j = 0; j < headers.length; j++) {
                        let value = values[j];
                        if (value && value.startsWith(quoteChar)) {
                            value = value.substring(1); // Remove prefix
                        }
                        if (value && value.endsWith(quoteChar)) {
                            value = value.substring(0, value.length - 1); // Remove suffix
                        }
                        
                        record[headers[j]] = value;
                    }
                    records.push(record);
                }
                console.log(`Successfully parsed ${records.length} records.`);
                return records;
            }

            // Handle the "Ingest" button click
            ingestBtn.onclick = async () => {
                const datFile = datFileInput.files[0];
                const nativeFiles = nativeFolderInput.files;
                const textFiles = textFolderInput.files;

                if (!datFile || nativeFiles.length === 0 || textFiles.length === 0) {
                    showModal("Please select the .dat file, the NATIVE folder, and the TEXT folder.");
                    return;
                }

                if (!userId) {
                    showModal("You must be logged in to ingest data.");
                    return;
                }

                ingestBtn.disabled = true;
                ingestBtn.textContent = "Ingesting...";
                ingestProgress.textContent = "Starting ingest...";

                try {
                    // Step 1: Read and parse the .dat file
                    ingestProgress.textContent = "Reading .dat file...";
                    const datContent = await readDatFileWithEncodings(datFile);
                    const records = parseDAT(datContent);
                    
                    if (records.length === 0) {
                        throw new Error("No records were parsed from the .dat file. Check file encoding and format.");
                    }
                    
                    // Step 2: Create file lookup maps
                    ingestProgress.textContent = "Indexing files...";
                    
                    const nativeFileMap = new Map();
                    for (const file of nativeFiles) {
                        const cleanPath = file.webkitRelativePath.replace(/\\/g, '/');
                        const key = cleanPath.substring(cleanPath.indexOf('/') + 1); // "NATIVE/..." -> "00000001/..."
                        nativeFileMap.set(key.toUpperCase(), file); // Use uppercase for robust matching
                    }
                    console.log(`Loaded ${nativeFileMap.size} native files into map.`);

                    const textFileMap = new Map();
                    for (const file of textFiles) {
                        const cleanPath = file.webkitRelativePath.replace(/\\/g, '/');
                        const key = cleanPath.substring(cleanPath.indexOf('/') + 1); // "TEXT/..." -> "00000001/..."
                        textFileMap.set(key.toUpperCase(), file); // Use uppercase for robust matching
                    }
                    console.log(`Loaded ${textFileMap.size} text files into map.`);

                    // Step 3: Loop, Upload to Storage, and Write to Firestore
                    let processedCount = 0;
                    const totalRecords = records.length;
                    
                    for (const record of records) {
                        const docId = record["Beg Bates"];
                        if (!docId) {
                            console.warn("Skipping record with no 'Beg Bates' ID:", record);
                            continue;
                        }
                        
                        const nativePathRaw = record["NativeFile"];
                        const textPathRaw = record["OCRPath"]; 

                        let nativeStoragePath = null;
                        let textStoragePath = null;
                        
                        // --- 3a. Upload Native File ---
                        if (nativePathRaw) {
                            const nativePath = nativePathRaw.replace(/\\/g, '/'); 
                            const nativeKey = nativePath.substring(nativePath.indexOf('/') + 1).toUpperCase(); // "NATIVE/..." -> "00000001/..."
                            const fileToUpload = nativeFileMap.get(nativeKey);

                            if (fileToUpload) {
                                try {
                                    const storageRef = ref(storage, `artifacts/${appId}/users/${userId}/natives/${docId}_${fileToUpload.name}`);
                                    await uploadBytes(storageRef, fileToUpload);
                                    nativeStoragePath = storageRef.fullPath;
                                } catch (uploadError) {
                                    console.error(`Failed to upload native ${nativePath}:`, uploadError);
                                }
                            } else {
                                console.warn(`Could not find matching NATIVE file for path: ${nativePath} (key: ${nativeKey})`);
                            }
                        }

                        // --- 3b. Upload Text File ---
                        if (textPathRaw) {
                            const textPath = textPathRaw.replace(/\\/g, '/');
                            const textKey = textPath.substring(textPath.indexOf('/') + 1).toUpperCase(); // "TEXT/..." -> "00000001/..."
                            const fileToUpload = textFileMap.get(textKey);

                            if (fileToUpload) {
                                try {
                                    const storageRef = ref(storage, `artifacts/${appId}/users/${userId}/text/${docId}.txt`);
                                    await uploadBytes(storageRef, fileToUpload);
                                    textStoragePath = storageRef.fullPath;
                                } catch (uploadError) {
                                    console.error(`Failed to upload text ${textPath}:`, uploadError);
                                }
                            } else {
                                console.warn(`Could not find matching TEXT file for path: ${textPath} (key: ${textKey})`);
                            }
                        }

                        // --- 3c. Prepare and write metadata to Firestore ---
                        const firestoreData = {
                            ...record, // Add all metadata from the .dat
                            nativeStoragePath: nativeStoragePath, 
                            textStoragePath: textStoragePath 
                        };

                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/docs`, docId);
                        await setDoc(docRef, firestoreData);
                        
                        processedCount++;
                        ingestProgress.textContent = `Processed ${processedCount} / ${totalRecords} documents...`;
                    }
                    
                    ingestProgress.textContent = `Ingest complete! Processed ${processedCount} documents.`;
                    showModal("Ingestion complete!");
                    reviewTabBtn.click(); // Switch to review tab

                } catch (error) {
                    console.error("Ingest Error:", error);
                    ingestProgress.textContent = `Error: ${error.message}`;
                    showModal(`Ingest failed: ${error.message}`);
                } finally {
                    ingestBtn.disabled = false;
                    ingestBtn.textContent = "Start Ingestion";
                }
            };

            // --- 4. REVIEW LOGIC ---

            // Listen for realtime updates to the document list
            function loadDocumentList() {
                if (unsubscribeDocListener) unsubscribeDocListener();
                
                const docsColRef = collection(db, `artifacts/${appId}/users/${userId}/docs`);
                const q = query(docsColRef); 

                unsubscribeDocListener = onSnapshot(q, (snapshot) => {
                    allDocuments = [];
                    snapshot.forEach((doc) => {
                        allDocuments.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort by 'Beg Bates' (doc.id)
                    allDocuments.sort((a, b) => a.id.localeCompare(b.id)); 
                    
                    docCountEl.textContent = `${allDocuments.length.toLocaleString()} documents loaded`;
                    renderDocumentList(allDocuments);
                    if (allDocuments.length > 0) {
                        docListPlaceholder.textContent = "Select a document.";
                        // Make AI panel usable
                        aiResponseContentEl.textContent = "Ask a question about your entire document set. The AI will search document metadata to find relevant files, read their text, and generate a (much more accurate) answer.";
                    } else {
                        docListPlaceholder.textContent = "No documents found. Go to the 'Ingest' tab to upload data.";
                        aiResponseContentEl.textContent = "Please ingest documents before using the AI assistant.";
                    }
                }, (error) => {
                    console.error("Error listening to documents:", error);
                    docListPlaceholder.textContent = `Error loading documents: ${error.message}`;
                });
            }

            // Helper function to generate a brief summary of a document based on metadata
            function generateDocumentSummary(doc) {
                // Priority: determine document type and create appropriate summary

                // Email detection
                if (doc._From || doc._To) {
                    const from = doc._From || 'Unknown';
                    const to = doc._To || 'Unknown';
                    const subject = doc._Subject ? ` - ${doc._Subject}` : '';
                    return `Email from ${from} to ${to}${subject}`;
                }

                // Document with subject
                if (doc._Subject) {
                    const date = doc._Date ? ` (${doc._Date})` : '';
                    return `${doc._Subject}${date}`;
                }

                // Document with filename
                if (doc['File Name']) {
                    const date = doc._Date ? ` (${doc._Date})` : '';
                    return `${doc['File Name']}${date}`;
                }

                // Notes as fallback
                if (doc.Notes) {
                    return doc.Notes.substring(0, 50) + (doc.Notes.length > 50 ? '...' : '');
                }

                // Default: just the document ID
                return doc.id;
            }

            // Handle Document List Searching - searches across ID, metadata, and text content
            docSearchEl.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (!searchTerm) {
                    renderDocumentList(allDocuments);
                    return;
                }

                // Search across multiple fields
                const filteredDocs = allDocuments.filter(doc => {
                    // Search in document ID (Beg Bates)
                    if (doc.id.toLowerCase().includes(searchTerm)) return true;

                    // Search in key metadata fields
                    const fieldsToSearch = ['_Subject', '_From', '_To', '_CC', 'File Name', 'Notes', '_Date'];
                    for (const field of fieldsToSearch) {
                        if (doc[field] && doc[field].toString().toLowerCase().includes(searchTerm)) {
                            return true;
                        }
                    }

                    // Note: Text content search is handled on the backend for AI queries
                    // Frontend search focuses on metadata for better performance
                    return false;
                });

                renderDocumentList(filteredDocs);
            });

            // Render the list of documents on the left
            function renderDocumentList(docs) {
                docListEl.innerHTML = ''; 
                
                if (docs.length === 0) {
                    docListPlaceholder.classList.remove('hidden');
                    if(allDocuments.length > 0) {
                        docListPlaceholder.textContent = "No documents match your search.";
                    }
                } else {
                    docListPlaceholder.classList.add('hidden');
                    const fragment = document.createDocumentFragment();
                    for (const doc of docs) {
                        const docItem = document.createElement('div');
                        docItem.className = 'doc-item p-3.5 border-b border-slate-700/50 cursor-pointer transition-all duration-200 text-slate-200';
                        docItem.dataset.docId = doc.id;

                        // Create document ID element (Beg Bates)
                        const docId = document.createElement('div');
                        docId.className = 'font-semibold text-sm truncate';
                        docId.textContent = doc.id;

                        // Create document summary element
                        const docSummary = document.createElement('div');
                        docSummary.className = 'text-xs text-slate-400 truncate mt-1';
                        docSummary.textContent = generateDocumentSummary(doc);

                        docItem.appendChild(docId);
                        docItem.appendChild(docSummary);

                        if (currentDocument && currentDocument.id === doc.id) {
                            docItem.classList.add('selected');
                        }

                        docItem.addEventListener('click', () => {
                            showDocument(doc);
                        });
                        fragment.appendChild(docItem);
                    }
                    docListEl.appendChild(fragment);
                }
            }
            
            /**
             * Attempts to fetch and read a text file from storage.
             * Tries multiple encodings, checking for BOMs first.
             * @param {string} url - The download URL for the text file.
             * @returns {Promise<string>} The decoded text content.
             */
            async function fetchAndDecodeText(url) {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch text file: ${response.statusText}`);
                }
                const arrayBuffer = await response.arrayBuffer();

                // 1. Check for Byte Order Mark (BOM)
                const dataView = new DataView(arrayBuffer);
                if (dataView.byteLength >= 2) {
                    const bom = dataView.getUint16(0, false); // Big-Endian
                    if (bom === 0xFEFF) {
                        console.log("Decoding as UTF-16BE (from BOM)");
                        return new TextDecoder('utf-16be', { fatal: true }).decode(arrayBuffer.slice(2));
                    }
                    if (bom === 0xFFFE) {
                        console.log("Decoding as UTF-16LE (from BOM)");
                        return new TextDecoder('utf-16le', { fatal: true }).decode(arrayBuffer.slice(2));
                    }
                }
                if (dataView.byteLength >= 3) {
                    if (dataView.getUint8(0) === 0xEF && dataView.getUint8(1) === 0xBB && dataView.getUint8(2) === 0xBF) {
                        console.log("Decoding as UTF-8 (from BOM)");
                        return new TextDecoder('utf-8', { fatal: true }).decode(arrayBuffer.slice(3));
                    }
                }

                // 2. No BOM found. Try decoding in order of probability.
                // Most non-BOM text files in eDiscovery are UTF-16LE or UTF-8.
                const encodingsToTry = ['utf-16le', 'utf-8', 'iso-8859-1'];
                
                for (const encoding of encodingsToTry) {
                    try {
                        const decoder = new TextDecoder(encoding, { fatal: true });
                        const text = decoder.decode(arrayBuffer);
                        console.log(`Successfully decoded text as ${encoding} (no BOM)`);
                        return text;
                    } catch (e) {
                        console.warn(`Could not decode as ${encoding} (no BOM).`, e.message);
                    }
                }
                
                throw new Error("Could not decode text file (tried UTF-16LE, UTF-8, and iso-8859-1).");
            }


            // Show the selected document's data
            async function showDocument(doc) {
                if (!doc) return;
                currentDocument = doc;

                // Switch to Review tab to show the document
                reviewTabBtn.click();

                // Update selected item in list
                document.querySelectorAll('.doc-item').forEach(el => {
                    el.classList.toggle('selected', el.dataset.docId === doc.id);
                });

                // Switch to text tab by default
                textTabBtn.click();

                // --- 1. Populate Text Panel ---
                textPanel.textContent = "Loading text...";
                if (doc.textStoragePath) {
                    try {
                        const textRef = ref(storage, doc.textStoragePath);
                        const url = await getDownloadURL(textRef);
                        const textContent = await fetchAndDecodeText(url);
                        textPanel.textContent = textContent || "[This document is empty]";
                    } catch (error) {
                        console.error("Error loading text:", error);
                        textPanel.textContent = `Error loading text: ${error.message}`;
                    }
                } else {
                    textPanel.textContent = `No text file was ingested for this document. (Original path: ${doc["OCRPath"] || 'N/A'})`;
                }

                // --- 2. Populate Metadata Panel ---
                metadataPanel.innerHTML = '';
                const metadataFragment = document.createDocumentFragment();
                const preferredKeys = ["Beg Bates", "End Bates", "_From", "_To", "_CC", "_SentDate", "_Subject", "NativeFile", "OCRPath"];
                const sortedKeys = Object.keys(doc).sort((a, b) => {
                    const aPref = preferredKeys.indexOf(a);
                    const bPref = preferredKeys.indexOf(b);
                    if (aPref > -1 && bPref > -1) return aPref - bPref; 
                    if (aPref > -1) return -1; 
                    if (bPref > -1) return 1;  
                    return a.localeCompare(b); 
                });

                for (const key of sortedKeys) {
                    if (key === 'id' || key === 'nativeStoragePath' || key === 'textStoragePath') continue; 
                    
                    const metaItem = document.createElement('div');
                    metaItem.className = 'mb-3';
                    metaItem.innerHTML = `
                        <div class="font-bold text-gray-400 text-xs uppercase">${key}</div>
                        <div class="text-gray-200 break-words">${doc[key] || 'N/A'}</div>
                    `;
                    metadataFragment.appendChild(metaItem);
                }
                metadataPanel.appendChild(metadataFragment);

                // --- 3. Populate Native Panel ---
                nativePanel.innerHTML = '<div class="p-4 text-gray-500">Loading native file...</div>';
                if (doc.nativeStoragePath) {
                    try {
                        const storageRef = ref(storage, doc.nativeStoragePath);
                        const url = await getDownloadURL(storageRef);
                        
                        const ext = doc.nativeStoragePath.split('.').pop().toLowerCase();
                        if (['pdf', 'txt', 'html', 'htm'].includes(ext)) {
                            nativePanel.innerHTML = `<iframe src="${url}" class="w-full h-full border-0"></iframe>`;
                        } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                            nativePanel.innerHTML = `<img src="${url}" alt="Native File" class="max-w-full max-h-full object-contain">`;
                        } else {
                            nativePanel.innerHTML = `
                                <div class="p-4 text-gray-400 text-center">
                                    <p class="mb-4">File type ".${ext}" cannot be previewed.</p>
                                    <a href="${url}" target="_blank" download
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition duration-150">
                                        Download Native File
                                    </a>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error("Error getting download URL:", error);
                        nativePanel.innerHTML = `<div class="p-4 text-red-400">Error loading native file: ${error.message}</div>`;
                    }
                } else {
                    nativePanel.innerHTML = '<div class="p-4 text-gray-500">No native file was ingested for this document.</div>';
                }
            }
            
            // --- 5. UI TABBING LOGIC ---
            function setupTabbing(tabContainerId, panelContainerId) {
                const tabButtons = document.querySelectorAll(`#${tabContainerId} .tab-btn`);
                const tabPanels = document.querySelectorAll(`#${panelContainerId} .tab-panel`);

                tabButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        tabButtons.forEach(b => b.classList.remove('active'));
                        tabPanels.forEach(p => p.classList.add('hidden'));
                        
                        btn.classList.add('active');
                        const panelId = btn.dataset.target;
                        document.getElementById(panelId).classList.remove('hidden');
                    });
                });
            }
            
            setupTabbing('main-tabs', 'main-views');
            setupTabbing('viewer-tabs', 'viewer-panels');

            // --- 6. AI ASSISTANT LOGIC (REFACTORED) ---

            // Function to parse simple markdown bold syntax
            function parseMarkdown(text) {
                if (!text) return '';
                // Escape HTML to prevent XSS
                const escaped = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');

                // Convert **text** to <strong>text</strong>
                return escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            }

            aiQueryBtn.addEventListener('click', () => runAiQuery());
            aiQueryInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') runAiQuery();
            });

            async function runAiQuery() {
                const userQuery = aiQueryInput.value;
                if (!userQuery || allDocuments.length === 0) {
                    aiResponseContentEl.textContent = "Please ask a question and ensure documents are loaded.";
                    return;
                }

                if (!userId) {
                    aiResponseContentEl.textContent = "Please wait for authentication to complete.";
                    return;
                }

                aiLoadingEl.classList.remove('hidden');
                aiResponseContentEl.classList.add('hidden');
                aiSourcesEl.classList.add('hidden');
                aiTokenInfoEl.classList.add('hidden');
                aiResponseContentEl.textContent = "";
                aiSourcesEl.innerHTML = "";
                aiTokenInfoEl.innerHTML = "";
                aiQueryBtn.disabled = true;

                console.log('AI Search Keywords:', [userQuery]); // Log the query for debugging

                try {
                    // Call the Cloud Function using the imported httpsCallable
                    const result = await docQuery({
                        query: userQuery,
                        userId: userId
                    });
                    
                    if (!result || !result.data) {
                        throw new Error('No response received from server');
                    }
                    
                    console.log('Cloud Function response:', result);
                    const { answer, sources, tokenInfo, usageInfo } = result.data;

                    if (!answer) {
                        throw new Error('No answer received from AI');
                    }

                    // Display response with markdown parsing
                    aiResponseContentEl.innerHTML = parseMarkdown(answer);

                    // Display sources
                    if (sources && sources.length > 0) {
                        aiSourcesEl.innerHTML = '<h4 class="text-sm font-semibold text-gray-400 mb-2">Sources:</h4>';
                        sources.forEach(source => {
                            const sourceLink = document.createElement('span');
                            sourceLink.className = 'ai-source-link';
                            sourceLink.textContent = source.id;
                            sourceLink.dataset.docId = source.id;
                            sourceLink.onclick = () => {
                                const docToOpen = allDocuments.find(d => d.id === source.id);
                                if (docToOpen) {
                                    showDocument(docToOpen);
                                    textTabBtn.click();
                                }
                            };
                            aiSourcesEl.appendChild(sourceLink);
                        });
                        aiSourcesEl.classList.remove('hidden');
                    }

                    // Display token information
                    if (tokenInfo) {
                        const percentUsed = Math.round((tokenInfo.estimatedInputTokens / tokenInfo.maxInputTokens) * 100);
                        let tokenInfoText = `📊 Processed ${tokenInfo.documentsProcessed} document(s) • Estimated tokens: ${tokenInfo.estimatedInputTokens.toLocaleString()} / ${tokenInfo.maxInputTokens.toLocaleString()} (${percentUsed}%)`;

                        // Add warning if present
                        if (tokenInfo.warning) {
                            tokenInfoText += ` <span class="text-yellow-400">⚠️ ${tokenInfo.warning}</span>`;
                        }

                        aiTokenInfoEl.innerHTML = tokenInfoText;
                        aiTokenInfoEl.classList.remove('hidden');
                    }

                    // Update usage display
                    if (usageInfo) {
                        usageDisplay.classList.remove('hidden');
                        if (usageInfo.isAdmin) {
                            usageText.textContent = 'Unlimited queries (Admin)';
                            usageText.className = 'text-green-400 font-semibold';
                        } else {
                            usageText.textContent = `${usageInfo.queriesRemaining} queries remaining this month`;
                            // Color code based on remaining queries
                            if (usageInfo.queriesRemaining <= 10) {
                                usageText.className = 'text-red-400 font-semibold';
                            } else if (usageInfo.queriesRemaining <= 25) {
                                usageText.className = 'text-yellow-400';
                            } else {
                                usageText.className = 'text-slate-400';
                            }
                        }
                    }

                } catch (error) {
                    console.error("AI Query Error:", error);
                    // Extract the actual error message from the Cloud Function response
                    const errorMessage = error.message || 
                                      (error.details && error.details.message) || 
                                      'Unknown error occurred';
                    aiResponseContentEl.textContent = `Error: ${errorMessage}`;
                    
                    // Show error in browser console for debugging
                    console.error('Full error details:', {
                        message: error.message,
                        code: error.code,
                        details: error.details
                    });
                } finally {
                    aiLoadingEl.classList.add('hidden');
                    aiResponseContentEl.classList.remove('hidden');
                    aiSourcesEl.classList.remove('hidden');
                    aiQueryBtn.disabled = false;
                }
            }

            // --- 7. MODAL (for alerts) ---
            const modal = document.createElement('div');
            modal.id = 'alert-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
                    <p id="modal-message" class="text-gray-200 mb-4">This is an alert.</p>
                    <button id="modal-close-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);

            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            function showModal(message) {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            }

            modalCloseBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
            
            // --- KICK OFF APP ---
            initializeAppLogic();
        });

    </script>
</body>
</html>